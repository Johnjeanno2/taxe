<!-- templates/geolocalisation/carte_zones.html -->
{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
<style>
  /* augmenter la hauteur de la carte */
  #map {
    height: 900px;
    min-height: 70vh;
    width: 100%;
    background: #fff;
    border-radius:6px;
    box-shadow:0 1px 6px rgba(0,0,0,0.08);
    position: relative;
    overflow: visible !important;
  }

  /* S'assurer que les contrôles Leaflet n'interfèrent pas */
  .leaflet-control-container {
    pointer-events: none !important;
  }

  .leaflet-control {
    pointer-events: auto !important;
  }

  /* Conteneur de la barre de recherche */
  .search-container {
    position: absolute;
    top: 20px;
    left: 20px;
    right: 20px;
    z-index: 9999 !important;
    display: flex !important;
    gap: 10px;
    max-width: 500px;
    pointer-events: auto !important;
  }

  /* Barre de recherche moderne */
  .search-box {
    flex: 1;
    position: relative;
    background: rgba(255, 255, 255, 0.98) !important;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25) !important;
    backdrop-filter: blur(10px);
    border: 2px solid rgba(15, 111, 182, 0.3) !important;
    transition: all 0.3s ease;
    min-height: 50px !important;
    pointer-events: auto !important;
  }

  .search-box:hover {
    box-shadow: 0 6px 25px rgba(0, 0, 0, 0.2);
    border-color: rgba(15, 111, 182, 0.3);
  }

  .search-box.focused {
    border-color: #0f6fb6;
    box-shadow: 0 6px 25px rgba(15, 111, 182, 0.25);
  }

  .search-input {
    width: 100%;
    padding: 15px 50px 15px 20px;
    border: none;
    background: transparent;
    font-size: 16px;
    color: #333;
    outline: none;
    border-radius: 12px;
  }

  .search-input::placeholder {
    color: #888;
    font-style: italic;
  }

  .search-icon {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: #0f6fb6;
    font-size: 18px;
    cursor: pointer;
    transition: color 0.3s ease;
  }

  .search-icon:hover {
    color: #2db45a;
  }

  /* Boutons d'action */
  .search-actions {
    display: flex;
    gap: 8px;
  }

  .search-btn {
    width: 50px;
    height: 50px;
    border: none;
    border-radius: 12px;
    background: linear-gradient(135deg, #0f6fb6, #2db45a) !important;
    color: white !important;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(15, 111, 182, 0.4) !important;
    display: flex !important;
    align-items: center;
    justify-content: center;
    pointer-events: auto !important;
    z-index: 9999 !important;
  }

  .search-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(15, 111, 182, 0.4);
  }

  .search-btn:active {
    transform: translateY(0);
  }

  /* Résultats de recherche */
  .search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: rgba(255, 255, 255, 0.98);
    border-radius: 0 0 12px 12px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    backdrop-filter: blur(10px);
    max-height: 300px;
    overflow-y: auto;
    display: none;
    z-index: 10001 !important;
    pointer-events: auto !important;
  }

  .search-result-item {
    padding: 12px 20px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    cursor: pointer;
    transition: background-color 0.2s ease;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .search-result-item:hover {
    background: rgba(15, 111, 182, 0.1);
  }

  .search-result-item:last-child {
    border-bottom: none;
  }

  .search-result-icon {
    color: #0f6fb6;
    font-size: 14px;
    width: 20px;
    text-align: center;
  }

  .search-result-text {
    flex: 1;
  }

  .search-result-title {
    font-weight: 600;
    color: #333;
    font-size: 14px;
  }

  .search-result-subtitle {
    color: #666;
    font-size: 12px;
    margin-top: 2px;
  }

  /* Loading spinner */
  .search-loading {
    display: none;
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
  }

  .spinner {
    width: 20px;
    height: 20px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #0f6fb6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: translateY(-50%) rotate(0deg); }
    100% { transform: translateY(-50%) rotate(360deg); }
  }

  /* Marqueurs de recherche et géolocalisation */
  .search-marker,
  .location-marker {
    background: none;
    border: none;
  }

  .search-marker-content,
  .location-marker-content {
    width: 30px;
    height: 30px;
    background: linear-gradient(135deg, #0f6fb6, #2db45a);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 14px;
    box-shadow: 0 3px 10px rgba(15, 111, 182, 0.4);
    border: 2px solid white;
    animation: markerPulse 2s infinite;
  }

  .location-marker-content {
    background: linear-gradient(135deg, #ff6b6b, #ee5a24);
    animation: locationPulse 1.5s infinite;
  }

  @keyframes markerPulse {
    0% { transform: scale(1); box-shadow: 0 3px 10px rgba(15, 111, 182, 0.4); }
    50% { transform: scale(1.1); box-shadow: 0 5px 15px rgba(15, 111, 182, 0.6); }
    100% { transform: scale(1); box-shadow: 0 3px 10px rgba(15, 111, 182, 0.4); }
  }

  @keyframes locationPulse {
    0% { transform: scale(1); box-shadow: 0 3px 10px rgba(255, 107, 107, 0.4); }
    50% { transform: scale(1.15); box-shadow: 0 5px 15px rgba(255, 107, 107, 0.6); }
    100% { transform: scale(1); box-shadow: 0 3px 10px rgba(255, 107, 107, 0.4); }
  }

  /* Popups personnalisés */
  .search-popup,
  .location-popup {
    min-width: 200px;
  }

  .search-popup h4,
  .location-popup h4 {
    margin: 0 0 8px 0;
    color: #0f6fb6;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .search-popup p,
  .location-popup p {
    margin: 0;
    color: #666;
    font-size: 12px;
  }

  .location-popup h4 {
    color: #ff6b6b;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .search-container {
      left: 10px;
      right: 10px;
      max-width: none;
    }

    .search-input {
      padding: 12px 45px 12px 15px;
      font-size: 14px;
    }

    .search-btn {
      width: 45px;
      height: 45px;
      font-size: 14px;
    }

    .search-marker-content,
    .location-marker-content {
      width: 25px;
      height: 25px;
      font-size: 12px;
    }
  }
</style>
{% endblock %}

{% block content %}
  <h1>Carte — Zones & Localisations</h1>
  <div id="map" role="application" aria-label="Carte OpenStreetMap"></div>
{% endblock %}

{% block extrajs %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="{% static 'geolocalisation/js/osm_map_integration.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  try {
    var app = new OSMMapIntegration('map');
    app.init();

    // Variables pour la recherche
    var searchInput = document.querySelector('.search-input');
    var searchResults = document.querySelector('.search-results');
    var searchBox = document.querySelector('.search-box');
    var searchIcon = document.querySelector('.search-icon');
    var searchLoading = document.querySelector('.search-loading');
    var locateBtn = document.getElementById('locate-btn');
    var resetViewBtn = document.getElementById('reset-view-btn');
    var searchTimeout;
    var currentSearchMarker = null;
    var zonesData = null;
    var localisationsData = null;

    // Initialiser la fonctionnalité de recherche
    function initSearch() {
      // Focus/blur events
      searchInput.addEventListener('focus', function() {
        searchBox.classList.add('focused');
      });

      searchInput.addEventListener('blur', function() {
        setTimeout(function() {
          searchBox.classList.remove('focused');
          hideSearchResults();
        }, 200);
      });

      // Recherche en temps réel
      searchInput.addEventListener('input', function() {
        var query = this.value.trim();

        clearTimeout(searchTimeout);

        if (query.length < 2) {
          hideSearchResults();
          return;
        }

        searchTimeout = setTimeout(function() {
          performSearch(query);
        }, 300);
      });

      // Clic sur l'icône de recherche
      searchIcon.addEventListener('click', function() {
        var query = searchInput.value.trim();
        if (query) {
          performSearch(query);
        }
      });

      // Entrée pour rechercher
      searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          var query = this.value.trim();
          if (query) {
            performSearch(query);
          }
        }
      });
    }

    // Effectuer la recherche
    function performSearch(query) {
      showLoading();

      // Recherche dans les données locales d'abord
      var localResults = searchLocalData(query);

      // Recherche via API de géocodage (Nominatim)
      var geocodeUrl = 'https://nominatim.openstreetmap.org/search?format=json&limit=5&q=' + encodeURIComponent(query);

      fetch(geocodeUrl)
        .then(response => response.json())
        .then(data => {
          hideLoading();
          var results = [...localResults];

          // Ajouter les résultats de géocodage
          data.forEach(function(item) {
            results.push({
              type: 'geocode',
              title: item.display_name.split(',')[0],
              subtitle: item.display_name,
              lat: parseFloat(item.lat),
              lon: parseFloat(item.lon),
              icon: getLocationIcon(item.type)
            });
          });

          displaySearchResults(results);
        })
        .catch(error => {
          hideLoading();
          console.error('Erreur de recherche:', error);
          displaySearchResults(localResults);
        });
    }

    // Rechercher dans les données locales
    function searchLocalData(query) {
      var results = [];
      query = query.toLowerCase();

      // Rechercher dans les zones
      if (zonesData && zonesData.features) {
        zonesData.features.forEach(function(feature) {
          var props = feature.properties;
          var name = (props.nom || props.name || '').toLowerCase();

          if (name.includes(query)) {
            var centroid = props.centroid;
            if (centroid) {
              results.push({
                type: 'zone',
                title: props.nom || props.name,
                subtitle: 'Zone',
                lat: centroid.lat,
                lon: centroid.lng,
                icon: 'fa-map-marked-alt',
                data: feature
              });
            }
          }
        });
      }

      // Rechercher dans les localisations
      if (localisationsData && localisationsData.features) {
        localisationsData.features.forEach(function(feature) {
          var props = feature.properties;
          var name = (props.contribuable__nom || props.name || '').toLowerCase();
          var zone = (props.zone__nom || '').toLowerCase();

          if (name.includes(query) || zone.includes(query)) {
            var coords = feature.geometry.coordinates;
            results.push({
              type: 'localisation',
              title: props.contribuable__nom || props.name,
              subtitle: 'Contribuable',
              lat: coords[1],
              lon: coords[0],
              icon: 'fa-user',
              data: feature
            });
          }
        });
      }

      return results;
    }

    // Obtenir l'icône selon le type de lieu
    function getLocationIcon(type) {
      var iconMap = {
        'city': 'fa-city',
        'town': 'fa-building',
        'village': 'fa-home',
        'restaurant': 'fa-utensils',
        'hotel': 'fa-bed',
        'shop': 'fa-shopping-cart',
        'hospital': 'fa-hospital',
        'school': 'fa-school',
        'university': 'fa-university',
        'bank': 'fa-university',
        'fuel': 'fa-gas-pump'
      };
      return iconMap[type] || 'fa-map-marker-alt';
    }

    // Afficher les résultats de recherche
    function displaySearchResults(results) {
      if (results.length === 0) {
        searchResults.innerHTML = '<div class="search-result-item"><div class="search-result-text"><div class="search-result-title">Aucun résultat trouvé</div></div></div>';
      } else {
        searchResults.innerHTML = results.map(function(result) {
          return '<div class="search-result-item" data-lat="' + result.lat + '" data-lon="' + result.lon + '" data-type="' + result.type + '">' +
            '<div class="search-result-icon"><i class="fas ' + result.icon + '"></i></div>' +
            '<div class="search-result-text">' +
            '<div class="search-result-title">' + result.title + '</div>' +
            '<div class="search-result-subtitle">' + result.subtitle + '</div>' +
            '</div></div>';
        }).join('');

        // Ajouter les événements de clic
        searchResults.querySelectorAll('.search-result-item').forEach(function(item, index) {
          item.addEventListener('click', function() {
            var lat = parseFloat(this.dataset.lat);
            var lon = parseFloat(this.dataset.lon);
            var type = this.dataset.type;

            goToLocation(lat, lon, results[index]);
            hideSearchResults();
            searchInput.value = results[index].title;
          });
        });
      }

      showSearchResults();
    }

    // Aller à une localisation
    function goToLocation(lat, lon, result) {
      // Supprimer le marqueur précédent
      if (currentSearchMarker) {
        app.map.removeLayer(currentSearchMarker);
      }

      // Centrer la carte
      app.map.setView([lat, lon], 15);

      // Ajouter un marqueur
      var icon = L.divIcon({
        className: 'search-marker',
        html: '<div class="search-marker-content"><i class="fas ' + result.icon + '"></i></div>',
        iconSize: [30, 30],
        iconAnchor: [15, 15]
      });

      currentSearchMarker = L.marker([lat, lon], { icon: icon }).addTo(app.map);

      // Popup avec informations
      var popupContent = '<div class="search-popup">' +
        {% block extrajs %}
        <!-- Google Maps API -->
        <script async defer src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&libraries=geometry,places&callback=__gmaps_init_old"></script>
        <script src="{% static 'geolocalisation/js/google_maps_integration.js' %}"></script>
        <script>
        function __gmaps_init_old(){
          try{
            var app = new GoogleMapsIntegration('map');
            app.init();

            setTimeout(function(){
              fetch('{% url "geolocalisation:all_zones_geojson" %}').then(r=>r.json()).then(d=>{ if(d.features) app.addZonesFromGeoJSON(d); });
              fetch('{% url "geolocalisation:localisations_geojson" %}').then(r=>r.json()).then(d=>{ if(d.features) app.addLocalisationsFromGeoJSON(d); });
            }, 300);
          } catch(e){ console.error('gmap init old', e); }
        }
        </script>
        {% endblock %}
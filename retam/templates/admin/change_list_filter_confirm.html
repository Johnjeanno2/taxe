{% extends "admin/base_site.html" %}

{% load i18n admin_list grp_tags admin_urls static %}

{% block stylesheets %}
    {{ block.super }}
    {{ media.css }}

    <style>
    :root{
        --bg: #f5f7f6;
        --card: #ffffff;
        --accent: #16a34a;
        --accent-dark: #0b5a2b;
        --muted: #6b7280;
        --surface: #f8fbf7;
        --radius: 12px;
        --shadow-sm: 0 6px 18px rgba(11,90,43,0.06);
        --shadow-lg: 0 12px 36px rgba(11,90,43,0.08);
        --gap: 14px;
    }

    /* Page */
    body, .grp-change-list { background: var(--bg); color: #0f1724; font-family: Inter, system-ui, -apple-system, "Helvetica Neue", Arial, sans-serif; }

    /* Layout */
    .l-2cr-fluid { display:flex; gap: 20px; align-items:flex-start; }
    .c-1 { width: 320px; flex: 0 0 320px; }
    .c-2 { flex: 1 1 auto; }

    /* Filters card */
    #grp-filters {
        background: linear-gradient(180deg, rgba(22,163,74,0.03), rgba(11,90,43,0.01));
        border-radius: var(--radius);
        padding: 14px;
        border: 1px solid rgba(11,90,43,0.06);
        box-shadow: var(--shadow-sm);
        margin-bottom: 14px;
    }
    #grp-filters h2 { margin:0 0 12px; color: var(--accent-dark); font-weight:700; font-size:1rem; }

    /* Pulldown */
    .grp-pulldown-container { position: relative; display:inline-block; }
    .grp-pulldown-handler { cursor:pointer; }
    .grp-pulldown-content {
        position: absolute;
        left: 0;
        top: calc(100% + 10px);
        min-width: 320px;
        background: var(--card);
        border-radius: 10px;
        box-shadow: var(--shadow-lg);
        border: 1px solid rgba(11,90,43,0.04);
        padding: 12px;
        display: none;
        z-index: 1300;
    }
    .grp-pulldown-content.show { display:block; }

    /* Table / results */
    .grp-module.grp-changelist-results { margin-bottom: 18px; }
    .grp-table, table, #result_list {
        width: 100%;
        border-collapse: collapse;
        background: var(--card);
        border-radius: 10px;
        overflow: hidden;
        box-shadow: var(--shadow-sm);
        border: 1px solid rgba(11,90,43,0.04);
    }

    /* En-têtes : gradient + texte blanc (très spécifique) */
    html body #result_list thead th,
    html body .grp-table thead th,
    html body table#result_list thead th,
    html body .grp-changelist-results thead th {
        background: linear-gradient(90deg, var(--accent) 0%, var(--accent-dark) 100%) !important;
        color: #ffffff !important;
        font-weight: 700;
        padding: 12px 16px;
        text-align: left;
        vertical-align: middle;
        white-space: nowrap;
        position: sticky;
        top: 0;
        z-index: 60;
    }
    /* Forcer tous les éléments internes des th en blanc (liens, icônes) */
    html body #result_list thead th *,
    html body .grp-table thead th * {
        color: #ffffff !important;
        fill: #ffffff !important;
        stroke: #ffffff !important;
        opacity: 1 !important;
    }

    /* Cells */
    .grp-table td, #result_list tbody td {
        padding: 12px 16px;
        border-bottom: 1px solid #eef6ef;
        color: #0f1724;
        font-size: 0.95rem;
        background: transparent;
    }
    .grp-table tr:nth-child(even), #result_list tbody tr:nth-child(even) { background: var(--surface); }
    .grp-table tr:hover, #result_list tbody tr:hover { background: #eefaf0; }

    /* Checkbox column */
    #result_list tbody td.action-checkbox { width: 48px; text-align:center; }
    input[type="checkbox"] { width:18px; height:18px; accent-color: var(--accent-dark); }

    /* Buttons */
    .grp-button, .button, input[type="submit"] {
        background: linear-gradient(90deg, var(--accent-dark), var(--accent)) !important;
        color:#fff !important;
        border:none !important;
        padding:8px 14px;
        border-radius:10px;
        font-weight:700;
        cursor:pointer;
        box-shadow: 0 8px 20px rgba(11,90,43,0.08);
    }
    .grp-button:hover, .button:hover, input[type="submit"]:hover { transform: translateY(-2px); }

    /* Row-level print button */
    #result_list tbody td .btn-print {
        display:inline-block;
        padding:8px 12px;
        border-radius:8px;
        background: linear-gradient(90deg,#28a745,#138e3c);
        color:#fff; font-weight:700; border:none;
    }

    /* Footer actions */
    footer.grp-submit-row, .grp-changelist-actions {
        background: linear-gradient(180deg, rgba(22,163,74,0.02), rgba(11,90,43,0.01));
        border-radius: 10px; padding: 10px; display:flex; gap:12px; justify-content:flex-end; align-items:center;
        border:1px solid rgba(11,90,43,0.02);
    }
    .grp-action-counter { padding:6px 10px; background:#f1fbf5; border-radius:8px; color:var(--accent-dark); font-weight:600; }

    /* Footer positioning */
    .grp-fixed-footer { left:0; right:0; bottom:0; z-index:1200; box-shadow: 0 -8px 30px rgba(0,0,0,0.12); }
    @media (min-width: 1100px) {
        .grp-fixed-footer { position: fixed !important; padding: 12px 18px; }
    }
    @media (max-width: 1099px) {
        .grp-fixed-footer { position: sticky !important; bottom: 0; }
    }
    @media (max-width: 760px) {
        .grp-fixed-footer { position: static !important; box-shadow:none; padding:10px 0; }
    }

    /* Responsive: convert to cards on small screens */
    @media (max-width: 760px) {
        #result_list thead { display: none; }
        #result_list tbody tr { display:block; margin-bottom:12px; background:var(--card); border-radius:10px; padding:10px; box-shadow: var(--shadow-sm); }
        #result_list tbody td { display:flex; justify-content:space-between; padding:8px 10px; border-bottom:none; }
        #result_list tbody td::before { content: attr(data-label); font-weight:700; color:var(--muted); width:45%; text-align:left; }
        #result_list tbody td > * { flex:1 1 auto; text-align:right; }
        .grp-button { width:100%; }
        .grp-pulldown-content { min-width: 90vw; left: auto; right: 0; }
    }

    </style>
{% endblock %}

{% block javascripts %}
    {{ block.super }}
    {{ media.js }}
    {% if cl.formset or action_form %}
        {% url 'admin:jsi18n' as jsi18nurl %}
        <script type="text/javascript" src="{{ jsi18nurl|default:'../../jsi18n/'}}"></script>
    {% endif %}

    <script type="text/javascript">
    (function($) {
        // pulldown toggle
        $(document).on('click', '.grp-pulldown-handler', function(e){
            e.preventDefault();
            var $c = $(this).closest('.grp-pulldown-container').find('.grp-pulldown-content');
            $('.grp-pulldown-content').not($c).removeClass('show');
            $c.toggleClass('show');
        });
        $(document).on('click', function(e){
            if (!$(e.target).closest('.grp-pulldown-container').length) {
                $('.grp-pulldown-content').removeClass('show');
            }
        });

        // adjust body padding so fixed footer doesn't cover content
        function adjustFooterPadding() {
            var $footer = $('.grp-fixed-footer');
            if (!$footer.length) return;
            if (window.matchMedia('(min-width: 1100px)').matches) {
                var h = $footer.outerHeight() || 0;
                $('body').css('padding-bottom', h + 'px');
            } else {
                $('body').css('padding-bottom', '');
            }
        }
        $(window).on('load resize orientationchange', adjustFooterPadding);
        setTimeout(adjustFooterPadding, 160);

        // add data-label attributes for mobile cards
        $(document).ready(function(){
            var headers = $('#result_list thead th .grp-text').map(function(){ return $(this).text().trim(); }).get();
            if (!headers.length) {
                headers = $('#result_list thead th').map(function(){ return $(this).text().trim(); }).get();
            }
            $('#result_list tbody tr').each(function(){
                $(this).find('td').each(function(i){
                    if (!$(this).attr('data-label')) $(this).attr('data-label', headers[i] || '');
                });
            });
        });
    })(grp.jQuery);
    </script>
{% endblock %}

{% block bodyclass %}grp-change-list{% endblock %}
{% block content-class %}{% endblock %}

{% block breadcrumbs %}
    {% if not is_popup %}
        <ul class="grp-horizontal-list">
            <li><a href="{% url 'admin:index' %}">{% trans "Home" %}</a></li>
            <li><a href="{% url 'admin:app_list' app_label=cl.opts.app_label %}">{{ cl.opts.app_config.verbose_name }}</a></li>
            <li>{{ cl.opts.verbose_name_plural|capfirst }}</li>
        </ul>
    {% endif %}
{% endblock %}

{% block content_title %}
    <h1>{{ cl.opts.verbose_name_plural|capfirst }}</h1>
{% endblock %}

{% block object-tools %}
    <ul class="grp-object-tools">
        {% block object-tools-items %}
            {% if has_add_permission %}
                {% url cl.opts|admin_urlname:'add' as add_url %}
                <li><a href="{% add_preserved_filters add_url is_popup %}" class="grp-add-link grp-state-focus">{% blocktrans with cl.opts.verbose_name as name %}Add {{ name }}{% endblocktrans %}</a></li>
            {% endif %}
        {% endblock %}
    </ul>
{% endblock %}

{% block content %}
    <div class="grp-module">
        <div class="grp-row">
            <div class="l-2cr-fluid {% if cl.has_filters and cl.search_fields %}l-d-12{% else %}{% if cl.has_filters or cl.search_fields %}l-d-6{% endif %}{% endif %}">
                {% if cl.has_filters or cl.search_fields %}
                    {% block aside %}
                        <aside class="c-1">
                            <header style="display:none"><h1>{% if cl.search_fields %}Search{% if cl.has_filters %} &amp; {% endif %}{% endif %}{% if cl.has_filters %}Filters{% endif %}</h1></header>
                            {% if cl.search_fields %}
                                {% block search %}
                                    <div id="search" class="g-d-6 g-d-f">
                                        {% search_form cl %}
                                    </div>
                                {% endblock %}
                            {% endif %}
                            {% if cl.has_filters %}
                                {% block filters %}
                                    <div id="grp-filters" class="g-d-6 g-d-l">
                                        <div class="grp-filter">
                                            <div class="grp-pulldown-container">
                                                <a href="javascript://" class="grp-button grp-pulldown-handler">{% trans 'Filters' %}</a>
                                                <div class="grp-pulldown-content">
                                                    {% for spec in cl.filter_specs %}{% admin_list_filter cl spec %}{% endfor %}
                                                    <div class="grp-module grp-pulldown-footer" style="margin-top:12px;">
                                                        <div class="grp-row">
                                                            <a href="" role="button" id="grp-filter-apply" class="grp-button">{% trans 'Apply' %}</a>
                                                            <a href="?" id="grp-filter-clear" class="grp-button grp-reset-link">{% trans 'Reset' %}</a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endblock %}
                            {% endif %}
                        </aside>
                    {% endblock %}
                {% endif %}
                {% block pagination_top %}
                    <div class="c-2">{% pagination cl %}</div>
                {% endblock %}
            </div>
        </div>
        {% block date_hierarchy %}{% if cl.date_hierarchy %}{% date_hierarchy cl %}{% endif %}{% endblock %}
    </div>

    <form id="grp-changelist-form" action="" method="post"{% if cl.formset.is_multipart %} enctype="multipart/form-data"{% endif %} novalidate>{% csrf_token %}
        <section id="grp-changelist" class="{% if cl.list_editable %} grp-editable{% endif %}">
            <header style="display:none"><h1>Results</h1></header>
            {% if is_popup %}<input type="hidden" name="_popup" value="1" />{% endif %}
            {% if cl.formset.errors %}
                <p class="errornote">
                    {% if cl.formset.total_error_count == 1 %}{% trans "Please correct the error below." %}{% else %}{% trans "Please correct the errors below." %}{% endif %}
                </p>
                {{ cl.formset.non_form_errors }}
            {% endif %}
            {% if cl.formset %}{{ cl.formset.management_form }}{% endif %}
            {% block result_list %}{% result_list cl %}{% endblock %}
        </section>

        {% if not cl.result_count == 0 %}
            {% block pagination_bottom %}
                <div class="grp-module"><div class="grp-row">{% pagination cl %}</div></div>
            {% endblock %}
        {% endif %}

        {% if cl.formset or action_form %}
            <footer id="submit" class="grp-module grp-submit-row grp-fixed-footer">
                <header style="display:none"><h1>Submit Options</h1></header>
                <ul>
                    {% if action_form %}<li class="grp-float-left grp-changelist-actions">{% admin_actions %}</li>{% endif %}
                    {% if cl.formset %}<li><input type="submit" class="grp-button grp-default" name="_save" value="{% trans "Save" %}"/></li>{% endif %}
                </ul>
            </footer>
        {% endif %}
    </form>
{% endblock %
